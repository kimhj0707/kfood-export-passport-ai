# K-Food Export Passport AI 개발일지

**날짜**: 2026-01-15

---

## 프로젝트 문서 목록 (.md)

| 파일명 | 설명 |
|--------|------|
| `README.md` | 프로젝트 소개 및 기본 사용법 |
| `README_DEPLOY.md` | Cloud Run 배포 가이드 |
| `SERVICE_MVP_PLAN.md` | 서비스 MVP 실행 계획 |
| `k_food_export_passport_ai_배포_next.md` | 배포 → Next.js 전환 마스터 문서 |
| `2026-01-14_개발일지.md` | 1일차 개발일지 (초기 파이프라인) |
| `2026-01-15_개발일지.md` | 2일차 개발일지 (서비스화 + UI 통합) |

---

## 프로젝트 개요

식품 라벨 이미지를 업로드하면 OCR로 텍스트를 추출하고, 수출국별 규정 체크 및 홍보 문구를 생성하는 AI 서비스

---

## 현재까지 완료된 기능 (STEP 1 완료)

| 모듈 | 파일 | 상태 |
|------|------|------|
| OCR (Google Vision) | `src/ocr/ocr_google.py` | ✅ 완료 |
| OCR (Tesseract) | `src/ocr/ocr_tesseract.py` | ✅ 완료 |
| 알레르겐 파싱 | `src/rules/allergen_parser.py` | ✅ 완료 |
| 영양성분 파싱 | `src/rules/nutrition_parser.py` | ✅ 완료 |
| 리스크 체커 | `src/rules/checker.py` | ✅ 완료 |
| 홍보 문구 생성 (LLM) | `src/llm/promo_generator.py` | ✅ 완료 |
| PDF 리포트 | `src/report/pdf_report.py` | ✅ 완료 |
| FastAPI 기본 | `src/api/main.py` | ✅ 완료 |
| Streamlit 데모 | `app.py` | ✅ 완료 |

---

## 오늘 작업 목표 (서비스 MVP 전환)

> **목표**: "데모"가 아닌 **"서비스"**로 보이는 최소 구성 완성
> **핵심**: 서비스의 3요소 (URL 접속 → 결과 페이지 → 히스토리)

---

## 작업 내역

### 1. SQLite DB 구축

**생성 파일:** `src/api/db.py`

**기능:**
- SQLite 연결 및 테이블 생성
- 분석 결과 저장 (report_id 발급)
- UUID 기반 고유 ID 생성

**스키마:**
```sql
CREATE TABLE reports (
    id TEXT PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    country TEXT NOT NULL,
    ocr_engine TEXT NOT NULL,
    ocr_text TEXT,
    allergens TEXT,      -- JSON string
    nutrition TEXT,      -- JSON string
    risks TEXT,          -- JSON string
    promo TEXT           -- JSON string
);
```

---

### 2. Pydantic 모델 정의

**생성 파일:** `src/api/models.py`

**모델:**
- `ReportCreate` - 분석 요청 시 입력 모델
- `ReportResponse` - 분석 결과 응답 모델
- `ReportListItem` - 히스토리 목록용 간소화 모델

---

### 3. FastAPI 확장

**수정 파일:** `src/api/main.py`

**추가 엔드포인트:**

| Method | Path | 설명 |
|--------|------|------|
| POST | `/api/analyze` | 이미지 분석 + DB 저장 + report_id 반환 |
| GET | `/api/reports/{id}` | 특정 리포트 조회 |
| GET | `/api/reports` | 최근 10개 목록 |
| GET | `/api/reports/{id}/pdf` | PDF 다운로드 |

---

## 현재 프로젝트 구조

```
kfood-export-passport-ai/
├── app.py                      # Streamlit 데모
├── requirements.txt
├── 2026-01-14_개발일지.md
├── 2026-01-15_개발일지.md      # (오늘)
├── SERVICE_MVP_PLAN.md
├── README.md
├── README_DEPLOY.md
├── k_food_export_passport_ai_배포_next.md
│
├── src/
│   ├── __init__.py
│   ├── ocr/
│   │   ├── __init__.py
│   │   ├── ocr_tesseract.py
│   │   └── ocr_google.py
│   ├── rules/
│   │   ├── __init__.py
│   │   ├── allergen_parser.py
│   │   ├── nutrition_parser.py
│   │   ├── checker.py
│   │   ├── us_fda.json
│   │   ├── jp_food_label.json
│   │   └── vn_food_label.json
│   ├── llm/
│   │   ├── __init__.py
│   │   └── promo_generator.py
│   ├── report/
│   │   ├── __init__.py
│   │   └── pdf_report.py
│   └── api/
│       ├── __init__.py
│       ├── main.py             # FastAPI 앱 (확장)
│       ├── db.py               # SQLite 연결 (신규)
│       └── models.py           # Pydantic 모델 (신규)
│
└── data/
    └── reports.db              # SQLite 파일 (자동 생성)
```

---

## 배포 완료

### Cloud Run 배포 (백엔드)

- **배포 완료**: 2026-01-15
- **API URL**: https://kfood-api-233469550454.asia-northeast3.run.app
- **Swagger UI**: https://kfood-api-233469550454.asia-northeast3.run.app/docs

**배포 과정:**
1. Docker 이미지 빌드 (`gcr.io/ksj-app/kfood-api`)
2. Artifact Registry 푸시
3. Cloud Run 서비스 생성 (asia-northeast3 리전)
4. 환경 변수 설정 (OPENAI_API_KEY, GOOGLE_APPLICATION_CREDENTIALS)

### Vercel 배포 (프론트엔드)

- **배포 완료**: 2026-01-15
- **프론트엔드 URL**: https://kfood-export-passport-ai-frontend.vercel.app
- **GitHub**: https://github.com/kimhj0707/kfood-export-passport-ai-frontend

**배포 과정:**
1. 프론트엔드 폴더명 변경: `kfood-export-passport-ai-frontend`
2. GitHub 레포지토리 생성 및 푸시
3. `vercel.json` 설정 파일 추가
4. Vercel CLI로 배포 (`vercel --prod`)
5. 환경 변수 설정: `VITE_API_BASE_URL`

---

## 배포 URL 요약

| 서비스 | URL |
|--------|-----|
| **프론트엔드 (Vercel)** | https://kfood-export-passport-ai-frontend.vercel.app |
| **백엔드 API (Cloud Run)** | https://kfood-api-233469550454.asia-northeast3.run.app |
| **API 문서 (Swagger)** | https://kfood-api-233469550454.asia-northeast3.run.app/docs |
| **GitHub (Frontend)** | https://github.com/kimhj0707/kfood-export-passport-ai-frontend |

---

## 다음 작업 예정

- [x] ~~Cloud Run 배포 (FastAPI)~~ ✅
- [x] ~~Vercel 배포 (React + Vite)~~ ✅
- [ ] 커스텀 도메인 연결 (선택사항)
- [ ] 모니터링 및 로깅 설정
- [ ] 추가 국가 규칙 확장 (EU, CN 등)

---

## 비용 안전 원칙 (유지)

| 항목 | 설정 |
|------|------|
| Cloud Run min-instances | 0 |
| Cloud Run max-instances | 1 |
| Budget Alert | 5,000원 |
| Vercel | Free tier |
| SQLite | 서버 내 파일 (비용 0) |

---

## 국가별 규칙 확장성 검토

현재 US/JP/VN 규칙 구조 분석 결과:
- **구조적으로 확장 가능**: 동일한 JSON 스키마 사용
- **코드 수정 불필요**: JSON 파일 키워드 추가만으로 개선 가능
- **US가 더 완성된 이유**: 키워드 풍부도 차이 (US: 8개 알레르겐, 다양한 변형)
- **추후 확장 포인트**: `required_labels` 필드 (JP/VN에만 있음, 현재 미사용)

---

## 생성된 파일 목록

### 1. `src/api/db.py`
- SQLite 연결 및 CRUD 함수
- `init_db()` - 테이블 초기화
- `save_report()` - 분석 결과 저장 + report_id 발급
- `get_report()` - 단일 리포트 조회
- `get_reports()` - 목록 조회 (히스토리)
- `delete_report()` - 리포트 삭제

### 2. `src/api/models.py`
- `AnalyzeResponse` - 분석 결과 응답 모델
- `ReportResponse` - 리포트 조회 응답 모델
- `ReportListItem` - 히스토리 목록용 간소화 모델
- `ReportListResponse` - 히스토리 목록 응답

### 3. `src/api/main.py` (수정)
- API 버전 2.0.0으로 업그레이드
- 신규 엔드포인트 추가
- 레거시 API 하위 호환 유지

---

## API 엔드포인트 (v2.0.0)

| Method | Path | 설명 |
|--------|------|------|
| GET | `/` | 헬스체크 |
| POST | `/api/analyze` | 이미지 분석 + DB 저장 + report_id 반환 |
| GET | `/api/reports/{id}` | 특정 리포트 조회 |
| GET | `/api/reports` | 최근 리포트 목록 (히스토리) |
| GET | `/api/reports/{id}/pdf` | PDF 다운로드 |
| DELETE | `/api/reports/{id}` | 리포트 삭제 |

### 레거시 API (하위 호환)
| Method | Path | 설명 |
|--------|------|------|
| POST | `/analyze` | 이미지 분석 (DB 저장 없음) |
| POST | `/report` | 이미지 → PDF 반환 (DB 저장 없음) |

---

## 실행 방법

### FastAPI 서버 실행
```bash
cd kfood-export-passport-ai
python -m uvicorn src.api.main:app --reload --port 8080
```

### API 문서 확인
- Swagger UI: http://localhost:8080/docs
- ReDoc: http://localhost:8080/redoc

---

## 테스트 예시

### 1. 헬스체크
```bash
curl http://localhost:8080/
```

### 2. 이미지 분석 (report_id 발급)
```bash
curl -X POST http://localhost:8080/api/analyze \
  -F "file=@label.jpg" \
  -F "country=US" \
  -F "ocr_engine=google"
```

### 3. 리포트 조회
```bash
curl http://localhost:8080/api/reports/{report_id}
```

### 4. 히스토리 목록
```bash
curl http://localhost:8080/api/reports?limit=10
```

### 5. PDF 다운로드
```bash
curl -O http://localhost:8080/api/reports/{report_id}/pdf
```

---

## Frontend UI 통합 (Vite + React)

### 작업 내용

기존 Stitch에서 생성된 UI (`k-food-수출-패스포트-ai/`)를 백엔드 API와 연동

### 수정 파일

| 파일 | 변경 내용 |
|------|-----------|
| `types.ts` | 백엔드 API 응답 타입 추가 (`ApiReportResponse` 등) |
| `services/api.ts` | Mock → 실제 API 호출로 변경 + 데이터 변환 함수 |
| `.env.local` | `VITE_API_BASE_URL` 설정 |

### 데이터 매핑

| UI 필드 | 백엔드 필드 | 변환 방식 |
|---------|-------------|-----------|
| `createdAt` | `created_at` | snake → camel |
| `ocrEngine` | `ocr_engine` | snake → camel |
| `nutrients` | `nutrition` | dict → array |
| `regulations` | `risks` | severity → type 변환 |
| `marketing` | `promo` | 필드명 매핑 |

### 프론트엔드 구조

```
k-food-수출-패스포트-ai/
├── App.tsx                    # 라우터 설정
├── types.ts                   # 타입 정의 (UI + API)
├── .env.local                 # 환경 변수
├── pages/
│   ├── LandingPage.tsx        # 랜딩 페이지
│   ├── AnalyzePage.tsx        # 업로드/분석
│   ├── ReportPage.tsx         # 결과 상세
│   └── HistoryPage.tsx        # 히스토리 목록
├── components/
│   ├── Header.tsx
│   └── Footer.tsx
└── services/
    └── api.ts                 # API 호출 + 변환 함수
```

---

## 통합 테스트 방법

### 1. 백엔드 실행
```bash
cd C:/KHJ/kfood-export-passport-ai
python -m uvicorn src.api.main:app --reload --port 8080
```

### 2. 프론트엔드 실행
```bash
cd C:/KHJ/kfood-export-passport-ai/k-food-수출-패스포트-ai
npm install
npm run dev
```

### 3. 브라우저 확인
- Frontend: http://localhost:3000
- Backend API: http://localhost:8080/docs

---

## 현재까지 완료된 기능 확인 가이드

### 전체 프로젝트 구조

```
kfood-export-passport-ai/
│
├── [Backend - Python/FastAPI]
│   ├── app.py                      # Streamlit 데모
│   ├── src/
│   │   ├── api/
│   │   │   ├── main.py             # FastAPI v2.0.0
│   │   │   ├── db.py               # SQLite CRUD
│   │   │   └── models.py           # Pydantic 모델
│   │   ├── ocr/                    # OCR 모듈
│   │   ├── rules/                  # 규칙 체크
│   │   ├── llm/                    # 홍보 문구 생성
│   │   └── report/                 # PDF 생성
│   └── data/
│       └── reports.db              # SQLite (자동 생성)
│
├── [Frontend - Vite/React]
│   └── k-food-수출-패스포트-ai/
│       ├── App.tsx
│       ├── types.ts
│       ├── .env.local
│       ├── pages/
│       ├── components/
│       └── services/api.ts
│
└── [문서]
    ├── README.md
    ├── README_DEPLOY.md
    ├── SERVICE_MVP_PLAN.md
    ├── k_food_export_passport_ai_배포_next.md
    ├── 2026-01-14_개발일지.md
    └── 2026-01-15_개발일지.md
```

---

### 기능 확인 방법

#### 1. Streamlit 데모 (빠른 확인)

```bash
cd C:/KHJ/kfood-export-passport-ai
streamlit run app.py
```
- 브라우저: http://localhost:8501
- 이미지 업로드 → OCR → 분석 → PDF 다운로드 확인

---

#### 2. FastAPI 백엔드 단독 테스트

```bash
cd C:/KHJ/kfood-export-passport-ai
python -m uvicorn src.api.main:app --reload --port 8080
```

**Swagger UI에서 테스트:**
- http://localhost:8080/docs

**API 엔드포인트:**
| Method | Path | 설명 |
|--------|------|------|
| GET | `/` | 헬스체크 |
| POST | `/api/analyze` | 이미지 분석 + DB 저장 |
| GET | `/api/reports` | 히스토리 목록 |
| GET | `/api/reports/{id}` | 리포트 상세 |
| GET | `/api/reports/{id}/pdf` | PDF 다운로드 |

**curl 테스트:**
```bash
# 헬스체크
curl http://localhost:8080/

# 이미지 분석 (test.jpg 사용)
curl -X POST http://localhost:8080/api/analyze \
  -F "file=@test.jpg" \
  -F "country=US" \
  -F "ocr_engine=google"

# 히스토리 조회
curl http://localhost:8080/api/reports
```

---

#### 3. Frontend + Backend 통합 테스트

**터미널 1 - 백엔드:**
```bash
cd C:/KHJ/kfood-export-passport-ai
python -m uvicorn src.api.main:app --reload --port 8080
```

**터미널 2 - 프론트엔드:**
```bash
cd C:/KHJ/kfood-export-passport-ai/k-food-수출-패스포트-ai
npm install
npm run dev
```

**브라우저 확인:**
| URL | 설명 |
|-----|------|
| http://localhost:3000 | Frontend 랜딩 페이지 |
| http://localhost:3000/#/analyze | 이미지 업로드 |
| http://localhost:3000/#/history | 분석 히스토리 |
| http://localhost:3000/#/reports/{id} | 결과 상세 |
| http://localhost:8080/docs | Backend Swagger UI |

---

### 테스트 시나리오

1. **랜딩 페이지** 접속 → "시작하기" 클릭
2. **분석 페이지**에서 `test.jpg` 업로드
3. 국가: US, OCR: Google Vision 선택
4. "분석 시작" 클릭 → 로딩 후 결과 페이지로 이동
5. **결과 페이지**에서 OCR 텍스트, 알레르겐, 규정 검토, 홍보 문구 확인
6. "PDF 다운로드" 클릭
7. **히스토리 페이지**에서 분석 기록 확인

---

### 환경 변수 설정

**Backend (.env):**
```
OPENAI_API_KEY=sk-xxx
GOOGLE_APPLICATION_CREDENTIALS=path/to/credentials.json
```

**Frontend (.env.local):**
```
VITE_API_BASE_URL=http://localhost:8080
```

---

### 주의사항

1. **Google Vision OCR** 사용 시 `GOOGLE_APPLICATION_CREDENTIALS` 필요
2. **LLM 홍보 문구** 생성 시 `OPENAI_API_KEY` 필요
3. 키가 없으면 Tesseract OCR + 더미 홍보 문구로 동작

---

(완료)
